<!doctype html>
<title>Linking to Data Table</title>
<link rel="stylesheet" type="text/css" href="./parcoords.css">
<link rel="stylesheet" type="text/css" href="style.css">
<style>
/* data table styles */

.grow { clear: left; font-size: 12px; line-height: 18px; height: 18px; }
.grow-div{height:200px; overflow-y: auto;}
.grow:nth-child(odd) { background: rgba(0,0,0,0.05); }
.header { font-weight: bold;
 height: 20px; background: rgba(0,0,0,0.5); }
.cell { float: left; overflow: hidden; white-space: nowrap; width: 100px; height: 18px; }
.col-0 { width: 180px; }

#example{
  height: 400px;
  width: 932px;
  display: inline-block;
}
#map{

  display: inline-block;
}


</style>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="./parcoords.standalone.js"></script>
<script src="lib/divgrid.js"></script>
<div class = "row">
    <div id="example" class="parcoords col s6" ></div>
    <div id="map" class ="col s6"></div>
    </div>


<div id="grid"></div>
<p>An extension of the <a href="brushing.html">bushing example</a> which links the chart to a data table. When hovering over the table, that row of data is highlighted in the chart. When brushing, the data in the table is updated.</p>
<p>The table is <a href="http://bl.ocks.org/3687826">divgrid</a>, a simple <a href="http://bost.ocks.org/mike/chart/">reusable chart</a> that follows <a href="http://bl.ocks.org/3808218">general update pattern I</a>.</p>
<p>Divgrid isn't fast when updating with hundreds or thousands of rows, so <strong>only the first 10 rows of the data are shown</strong>. For better performance, use a more sophisticated data grid like <a href="https://github.com/mleibman/SlickGrid">SlickGrid</a>.</p>
<p>There is an <a href="http://exposedata.com/parallel/">old example</a> of SlickGrid with parallel coordinates. In that version the SVG is a bottleneck. An example of SlickGrid with this library should appear in the next few weeks (Nov-Dec, 2012).</p>
<button id ="2010" onclick="h2010('20155.csv')">2010</button>
<button id ="2005" onclick="h2010('20055.csv')">2005</button>
<button id ="2000" onclick="h2010('20005.csv')">2000</button>
<button id ="1995" onclick="h2010('20000.csv')">1995</button>
<script id="brushing">// quantitative color scale
  var width = 600;
  var height = 450;
  var padding = 10;
  var k;
  var node;

  var pixelLoc = d3.geoMercator();
  var filter =[];
 var colors = d3.scaleOrdinal()
    .domain(["Europe","South America","North America","Asia","Africa","Oceania"])
    .range(["#5E4FA2", "#3288BD", "#66C2A5", "#ABDDA4", "#E6F598", 
    "#FFFFBF"]);
 

  svg = d3.select('#map')
          .append('svg:svg')
          .attr('width', width)
          .attr('height', height)
          .attr("class", "svgn");

var blue_to_brown = d3.scaleLinear()
  .domain([0, 100])
  .range(["steelblue", "brown"])
  .interpolate(d3.interpolateLab);

var color = function(d) { return colors(d['continent']); };

var parcoords = ParCoords()("#example")
  .color(color)
  .alpha(0.4)
    .margin({
      top: 36,
      left: 100,
      right: 100,
      bottom: 16
    });
    var dimensions = {
                "country": {
                    title: "Country",
                },
                "leader": {
                    title: "Leader",
                    scale: 'linear',
                },
                "tech": {
                    title: "Tech",
                },
                "proud": {
                    title: "Proud",
                    //yscale: d3.scaleLinear().domain([100,0]).range([100, 0])
              },
              "trust": {
                    title: "Trust",
                },
                "jobs": {
                    title: "Jobs",
                },
                "politics": {
                    title: "Politics",
                },
                "war": {
                    title: "War",
                },
            };
// load csv file and create the chart
var h2010 = function(file){
  svg.selectAll('text').remove();
d3.csv(file).then(function(data) {
  var coords = [];
    var xs = [];
    var ys = []
    for (i = 0; i<data.length;i++) {
        ////console.log(pixelLoc([Number(countries[i].longitude),Number(countries[i].latitude)])[0],countries[i])
      xs.push(pixelLoc([Number(data[i].longitude),Number(data[i].latitude)])[0]);
      ys.push(pixelLoc([Number(data[i].longitude),Number(data[i].latitude)])[1]);
    }
    //console.log(xs)
    var minX = d3.min(xs);
    var maxX = d3.max(xs);
    //console.log(minX,maxX,"def")

   var xScale = d3.scaleLinear().domain([minX,maxX]).range([50, width-50]);

    var minY = d3.min(ys);
    var maxY = d3.max(ys);
    var yScale = d3.scaleLinear().domain([minY,maxY]).range([50, height-50]);
    //console.log(pixelLoc([0,0]),"pling")
    //console.log(pixelLoc([180,89]))
    var pointScale = d3.scaleSqrt().domain([0, 100]).range([0, 32]);

  parcoords
    .data(data)
    .dimensions(dimensions)
    //.hideAxis(["tech"])
    .render()
    .reorderable()
    .brushMode("1D-axes");  // enable brushing


    d3.keys(dimensions).forEach( d=>{
      if (d!="country"){
      parcoords.scale(d, [0, 100])
      }
    });

  // create data table, row hover highlighting
  var grid = d3.divgrid(dimensions);
  d3.select("#grid")
    .datum(data)
    .call(grid);

  var rows = d3.select('#grid').selectAll('.grow');
  rows.on("mouseover", function(d) {
    if (d3.event.target.classList.contains("cell")) {
              rowen = d3.event.target.parentElement;
              }else if(d3.event.target.classList.contains("grow")){
               rowen = d3.event.target;
              };
      if(rowen.checked){}else{
              //console.log(rowen.checked);
              var farg = "color :"+colors(d.continent);
              if (d3.event.target.classList.contains("cell")) {
                //console.log(d3.event.target.parentElement)
              d3.event.target.parentElement.setAttribute("style", farg);
              }else if(d3.event.target.classList.contains("grow")){
                d3.event.target.setAttribute("style", farg)
              };
              border(d.country,"red")
              parcoords.highlight([d]) }});

    rows.on("click", function(d) {


        });
    rows.on("mouseout", function(d) {
      if (d3.event.target.classList.contains("cell")) {
                //console.log(d3.event.target.parentElement)
              d3.event.target.parentElement.setAttribute("style", "color : black");
              }else if(d3.event.target.classList.contains("grow")){
                d3.event.target.setAttribute("style", "color : black")
              };
              border(d.country,"none")
        parcoords.unhighlight();});


    var header = d3.select(".header").on('click',(d)=>{
      var found = false;
      filter = filter.map( t => {if (d3.event.target.innerHTML != t){ return t}else{found = true;}});
      if (found){
      }
      else{
        filter.push(d3.event.target.innerHTML);
      }
      var cloneDims = JSON.parse(JSON.stringify(dimensions));
      filter.forEach(f => {
        delete cloneDims[f];
      })
      
      //console.log(cloneDims)
      parcoords.dimensions(cloneDims)

    parcoords.render().updateAxes();
      //console.log(d3.event.target.innerHTML)
      d3.keys(cloneDims).forEach( d=>{
      if (d!="country"){
      parcoords.scale(d, [0, 100])
      }
    });
    });
      
  // update data table on brush event
  parcoords.on("brush", function(d) {
    //console.log(d);
    //console.log(d);
    // var newNodes = createNodes(d);
     animator(d);
     //svg.selectAll("text").raise();




    d3.select("#grid")
      .datum(d)
      .call(grid)
      .selectAll(".grow")
      var rows = d3.select('#grid').selectAll('.grow');
  rows.on("mouseover", function(d) {
              var farg = "color :"+colors(d.continent);
              if (d3.event.target.classList.contains("cell")) {
                //console.log(d3.event.target.parentElement)
              d3.event.target.parentElement.setAttribute("style", farg);
              }else if(d3.event.target.classList.contains("grow")){
                d3.event.target.setAttribute("style", farg)
              };
              border(d.country,"red")
              parcoords.highlight([d]) });

    rows.on("click", function(d) {
              
              deselect(d) });
    rows.on("mouseout", function(d) {
      if (d3.event.target.classList.contains("cell")) {
                //console.log(d3.event.target.parentElement)
              d3.event.target.parentElement.setAttribute("style", "color : black");
              }else if(d3.event.target.classList.contains("grow")){
                d3.event.target.setAttribute("style", "color : black")
              };
              border(d.country,"none")
        parcoords.unhighlight();});
  });
  //console.log(d3.select("#grid").selectAll("row").attr("adsf","blee"))
  var animator = function(data){
  var u = svg.selectAll('circle')
    .data(data,(item,i,k)=> {
  //console.log(countries)
      //console.log(item,i,k,"wadå")
        //console.log(item)
        ////console.log(node)
        knas = pixelLoc([Number(item.longitude),Number(item.latitude)])[0]
        ////console.log(knas,pixelLoc,"här e knas")
        item.x = xScale(knas);
        ////console.log(node.x,'vadå')
        extra = pixelLoc([Number(item.longitude),Number(item.latitude)])[1]
        ////console.log(extra,pixelLoc)
        item.y = yScale(extra);
        ////console.log(node.y,'jamen')
        item.radius = pointScale((Number(item.leader)));
        
    return item})
    u.enter()
    .append('svg:circle')
    .attr('r', function(d) {
      return d.radius
    })
    .attr('class', function(d) {
            return d.country.replace(' ', '');
          })
          .attr("fill", d=>{
           return colors(d.continent)
          })
          .on("mouseover", function(d) {
            border(d.country, "red");
            parcoords.highlight([d]);
          })
          .on("mouseout", function(d){
            border(d.country,"none");
          parcoords.unhighlight();
          });
    u.exit().remove();

    var v = svg.selectAll('text')
      .data(data)
      

      v.enter().append('svg:text')
        .text(function(d) {
        return d.country;
        })
        .attr('text-anchor',"middle");

      v.exit().remove();
    
      var simulation = d3.forceSimulation(data)
    .force('collision', d3.forceCollide().radius(function(d) {
      return d.radius
    }))
    .on('tick', ticked);
  function ticked() {
    var k = svg.selectAll('circle')
    k.merge(u)
    .attr('cx', function(d) {
      return d.x
    })
    .attr('cy', function(d) {
      return d.y
    
    })
    var vv = svg.selectAll('text')
      

    vv.merge(v)
      .attr('x', function(d) {         if (isNaN(d.radius)) {
          return 0;
        }
        ////console.log(node.radius,node.country)
        return d.x; })
      .attr('y', function(d) {        if (isNaN(d.radius)) {
          return 0;
        }
        ////console.log(node.radius,node.country)
        return d.y+2; })
      .attr('opacity', function(d) {
        if (isNaN(d.radius)) {
          return 0;
        }
        ////console.log(node.radius,node.country)
        return 1;
      });
      v.exit().remove();
    k.exit().remove();

  }

    }
    animator(data);
    //svg.selectAll("text").raise();
    var border = function(country,color1){
      var classen = "."+country.replace(" ","") 
      //console.log(classen)
      var du = svg.select(classen).attr("stroke", color1);
    }

    var deselect = function(){return 0};
    
});
};
h2010('20155.csv');





</script>
